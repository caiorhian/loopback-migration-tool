{"version":3,"sources":["migrate.js"],"names":["argv","isAbsolute","app","process","cwd","require","loopback","default","resolve","reject","on","specificDS","ds","length","specificModels","model","map","modelName","lowerCase","ignored_model","datasources","chain","toArray","uniq","value","dsByName","keyBy","elem","settings","name","dsName","forEach","keys","modelsByDS","models","Model","definition","dataSource","modelNameLower","includes","push","isUpdateMethod","method","promises","modelNames","dsLowerName","migrateMethod","autoupdate","automigrate","console","log","promisify","context","then","all"],"mappings":"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","file":"migrate.js","sourcesContent":["\"use strict\"\n/**\n * Created by garusis on 31/01/17.\n */\nimport path from \"path\"\nimport _ from \"lodash\"\nimport Promise from \"bluebird\"\nimport debug from \"debug\"\n\n\nexport default function (argv) {\n    if (!path.isAbsolute(argv.app)) {\n        argv.app = `${process.cwd()}/${argv.app}`\n    }\n    let app = require(argv.app)\n    if (!app.loopback && app.default && app.default.loopback) //exported as a ES6 module.\n        app = app.default\n\n    return new Promise(function (resolve, reject) {\n        app.on('booted', function () {\n            let specificDS = !!argv.ds.length\n            let specificModels = !!argv.model.length\n\n            if (specificModels) argv.model = _.map(argv.model, (modelName) => _.lowerCase(modelName))\n            argv.ignored_model = _.map(argv.ignored_model, (modelName) => _.lowerCase(modelName))\n\n            let datasources = _.chain(app.datasources).toArray().uniq().value() //remove duplicated datasources\n            let dsByName = _.keyBy(datasources, (elem) => _.lowerCase(elem.settings.name))\n\n            if (specificDS) {\n                argv.ds = _.map(argv.ds, (dsName) => _.lowerCase(dsName))\n\n                datasources = {}\n                _.forEach(argv.ds, function (ds) { //filter to get the specific datasources\n                    datasources[ds] = dsByName[ds]\n                })\n            } else {\n                datasources = dsByName\n                argv.ds = _.keys(datasources)\n            }\n\n\n            let modelsByDS = {}\n\n            _.forEach(app.models, function (Model) {\n                let modelName = Model.definition.name\n                if (Model.dataSource) {\n                    let dsName = _.lowerCase(Model.dataSource.settings.name)\n                    let modelNameLower = _.lowerCase(modelName)\n                    if (!datasources[dsName] || _.includes(argv.ignored_model, modelNameLower)) return\n\n                    if (!specificModels || (specificModels && _.includes(argv.model, modelNameLower))) {\n                        if (!modelsByDS[dsName]) {\n                            modelsByDS[dsName] = []\n                        }\n                        modelsByDS[dsName].push(modelName)\n                    }\n                }\n            })\n\n            let isUpdateMethod = argv.method === 'update'\n            let promises = _.map(modelsByDS, function (modelNames, dsLowerName) {\n                let ds = datasources[dsLowerName]\n                let migrateMethod = isUpdateMethod ? ds.autoupdate : ds.automigrate\n                if (!migrateMethod) return Promise.resolve()\n\n                console.log(`---------------Start to migrate the ${ds.settings.name} datasource with ${argv.method} method`)\n                console.log(`Models to migrate ${JSON.stringify(modelNames)}`)\n                migrateMethod = Promise.promisify(migrateMethod, {context: ds})\n                return migrateMethod(modelNames)\n                    .then(function () {\n                        console.log(`---------------${ds.settings.name} datasource migration finished.`)\n                    })\n            })\n\n\n            return Promise.all(promises)\n        })\n    })\n}"],"sourceRoot":"./"}